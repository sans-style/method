<h1>{{title}}</h1>
<p>Welcome to {{title}}</p>

<div id ="pagesList">
<ul>
	<li class = "pageListItem noSelect" name = "root" id = "root" data-pageId = "0">Root</li>
{{#each pages}}
	<li class = "pageListItem noSelect" name = "pageLabel{{this.id}}" id = "pageLabel{{this.id}}" data-pageId = "{{this.id}}">{{{this.label}}}</li>
{{/each}}
</ul>
</div>

<p id="pageSelectionMessage">default message</p>

<form id= "newPageForm" action="/" method = "post">
<input class = "hidden selectedPageInfo" name = "newPageSelectedPageId" value = "{{selectedPage}}">
<input name = "newPageName" type="text" placeHolder = "Enter new Page Name" required pattern = "[a-z0-9.]+">
<input type="submit" value = "Create new Page">
</form>

<form id = "textAreaForm" action="/" method = "post">
<input class = "hidden selectedPageInfo" name = "textAreaSelectedPageId" value = "{{selectedPage}}">
	<input type = "submit" value = "Save">
	<textarea style = "white-space: pre-wrap" name = "inputField" id = "inputField" rows = "20" cols = "100">{{placeHoldText}}</textarea>
</form>

<div id = "versionSelectionForm">
<input class = "hidden selectedPageInfo" name = "versionSelectionSelectedPageId" value = "{{selectedPage}}">

<select name="versionSelection" id = "versionSelection">

	{{#each versionTimes}}
	<option value = "{{this.number}}">{{this.date}}</option>
	{{/each}}
	
</select>
</div>

<p id = "debugText">{{error}}</p>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>


<script>


var defaultDisplayedText = "{{placeHoldText}}";
var selectedPage = {{selectedPage}};
var pagesTitlesArray = [];
var pagesPathArray = [];
var pagesDataArray = [];
var versionsArray = [];
var pageVersions = [];
var journalText = "";
var re = /\r\n/g;
journalText = journalText.replace(re, "<br>");
defaultDisplayedText = defaultDisplayedText.replace(re, "<br>");


{{#each pages}}
	pagesTitlesArray.push("{{this.name}}");
	pagesPathArray.push("{{this.path}}");
	journalText = "{{this.data}}";
	journalText = journalText.replace(re, "<br>");
	pagesDataArray.push(journalText);
	pageVersions = [];
	{{#each this.versions}}
		pageVersions.push("{{this.date}}");
	{{/each}}
	versionsArray.push(pageVersions);
{{/each}}

console.log(versionsArray);

$("document").ready(function(){

	if(selectedPage===0) {
		$("#versionSelection").addClass("hidden");
	}

	//this code is responsible for requesting a particular version of a page and displays the response in the textarea
	$("#versionSelection").change(function() {
	let selectedVersion = $("#versionSelection").val();
	console.log("requesting version: " + selectedVersion);
		$.getJSON("/db/retrieve", {selectedPageId: selectedPage, requestedVersion: selectedVersion}, function(data) {
			$("#inputField").html(data.journalText);
		});
	});
	
	//set default values based on selected page
	$("#pageSelectionMessage").html("Current Page : " + "{{selectedPagePath}}" + "<br>Current Note : {{placeHoldText}}");
	
	$("#inputField").html(defaultDisplayedText);
	
	//these functions are responsible for displaying the appropriate information when the user clicks on a given page
	//It is also responsible for changing the hidden inputfields so that the server will know what the selcetedPage is
	$("#root").click(function(){
		
		$("#pageSelectionMessage").html("Current Page : Root<br>CurrentNote : " + "root note");
		
		$("#inputField").html("root note");
		
		$(".selectedPageInfo").each(function(){
			$(this).attr("value", "0");
		});
		selectedPage = 0;
		
		$("#versionSelection").addClass("hidden");
	});
	
	{{#each pages}}
	
	$("#pageLabel{{this.id}}").click(function(){
		
		$("#pageSelectionMessage").html("Current Page : " + "{{this.path}}<br> CurrentNote : " + "{{this.data}}");
		$("#inputField").html("{{this.data}}");
		
		$(".selectedPageInfo").each(function(){
			$(this).attr("value", "{{this.id}}");
		});
		selectedPage = {{this.id}};
		
		let htmlString = "";
		let i = 0;
		let j = 0;
		//console.log("{{@index}}");
		i = {{@index}};
		console.log("i = " + i);
		
		{{#each this.versions}}
			j = {{@index}} {{this.versions}};
			htmlString += '<option value = "' + j + '">' + versionsArray[i][j] + '</option>';
		{{/each}}

		$("#versionSelection").html(htmlString);
		
		$("#versionSelection").removeClass("hidden");
	});
	

	
	{{/each}}
});


</script>
